<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="./assets/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management</title>

    <!-- LINK STYLESHEETS -->
    <link rel="stylesheet" href="./css/bootstrap-4.0.0.css">
    <link rel="stylesheet" href="./lib/semantic/dist/semantic.min.css">
    <link rel="stylesheet" href="./lib/sweetalerts/sweetalert.css">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/fonts.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
   
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12 pt-4">
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                      <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
                      <a class="navbar-brand" href="#">CCMS</a>
                      <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                        <li class="nav-item ">
                          <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="cases.html">Cases <span class="sr-only">(current)</span></a>
                          </li>
                        <li class="nav-item">
                          <a class="nav-link" href="clients.html">Clients</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link " href="document.html">Documents</a>
                        </li>
                        <li class="nav-item active admin_setting">
                            <a class="nav-link " href="user_management.html">User Management</a>
                          </li>
                      </ul>
                      <form class="form-inline my-2 my-lg-0">
                        <h3 class="d-inline"> <i class="icon user"></i> <span id="display_name">N/A</span> (<span class="text-dark" id="display_role">N/A</span>)</h3>
                        
                      </form>
                    </div>
                  </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <hr>
            </div>
            <div class="col-8">
                <h1 class="display-4" sty>USER MANAGEMENT <i class="icon user"></i></h1>
            </div>
            <div class="col-4">
              <button data-backdrop="static" data-toggle="modal" data-target="#newUserModal" class="btn btn-lg btn-block btn-outline-dark">Create New User <i class="icon plus circle"></i></button>
            </div>
            <div class="col-9 " >
              <hr>
                <div class="row">
                  <div class="col-12 ui label" id="list_segment">
                    <table class="table table-hover table-sm table-bordered" id="users_table">
                      <thead class="bg-dark bg-dark">
                          <th>#</th>
                          <th>FIRSTNAME</th>
                          <th>LASTNAME</th>
                          <th>OTHERNAME(s)</th>
                          <th>EMAIL ADDRESS</th>
                          <th>ROLE</th>
                          <th>STATUS</th>
                          <th></th>
                      </thead>
                      <tbody>
                        
                      </tbody>
                  </table>
                  </div>
                </div>
                <style>
                  #users_table thead th{
                    color: white;
                    font-family: 'YU Gothic UI' !important;
                  }
                </style>
            </div>
            <div class="col-3" >
               <div class="row">
                 <div class="col-2"></div>
                 <div class="col-10 px-1 border border-dark-left" style="height: 60vh;">
                  <h3 class="p-3 text-white bg-dark">Controls</h3>
                  <hr>
                  <button onclick="resetPassword()" class="btn btn-block btn-dark btn-lg">Reset Password</button>
                  <button onclick="deleteUser()" class="btn btn-block btn-dark btn-lg">Delete User(s)</button>
                 </div>
               </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="newUserModal" tabindex="-1" role="dialog" aria-labelledby="newUserModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form class="modal-content segment ui" id="newUserForm">
          <div class="modal-header bg-dark">
            <h5 class="modal-title text-white" id="newUserModalLabel">CREATE NEW SYSTEM USER</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div class="form-row">
                <div class="col-4 form-group">
                  <input type="text" name="Firstname" placeholder="Firstname" class="form-control form-control-lg" required>
                </div>
                <div class="col-4 form-group">
                  <input type="text" name="Middlename" placeholder="Middlename" class="form-control form-control-lg">
                </div>
                <div class="col-4 form-group">
                  <input type="text" name="Lastname" placeholder="Lastname" class="form-control form-control-lg" required>
                </div>
                <div class="col-5 form-group">
                  <select name="Gender" class="form-control form-control-lg" required>
                      <option value="" selected>Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                  </select>
                </div>
               
                <div class="col-7 form-group">
                  <select name="Role" class="form-control form-control-lg" required>
                      <option value="" selected>Role</option>
                      <option value="CLERK">CLERK</option>
                      <option value="LAWYER">LAWYER</option>
                      <option value="ADMINISTRATOR">ADMINISTRATOR</option>
                  </select>
                </div>
                <div class="col-12 form-group">
                  <input type="email" placeholder="Email Address *" name="EmailAddress" class="form-control form-control-lg" required>
                </div>
              </div>
          </div>
          <div class="modal-footer">
            <button type="reset" id="resetButton" class="btn btn-dark btn-lg" data-dismiss="modal">Discard</button>
            <button type="submit" class="btn btn-success btn-lg">Submit Now <i class="icon check"></i></button>
          </div>
        </form>
      </div>
    </div>
    
    
    <!-- LINK JAVASCRIPTS -->
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/bootstrap-4.0.0.js"></script>
    <script src="./js/jquery.table2excel.js"></script>
    <script src="./lib/semantic/dist/semantic.min.js"></script>
    <script src="./lib/sweetalerts/sweetalert.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="./js/app.jsx"></script>

    <script>
        
        resolveUserData()
        if(userdata.Role.toUpperCase() !== 'ADMINISTRATOR'){
          window.location.href = 'index.html'
        }

        let users_table = $('#users_table').DataTable()
        let USERS,selectedUser

        $("#newUserForm").submit(e=>{
          e.preventDefault()
          createNewUser()
        })

        $(document).ready(()=>{
         
          fetchAllUsers()
        })

    </script>
    <script>
      function createNewUser(){
        const userdata = getFormData("newUserForm")
        console.log(userdata)
        const URLParams = Object.keys(userdata).filter(k => userdata.hasOwnProperty(k)).map(
        k => encodeURIComponent(k) + '=' + encodeURIComponent(userdata[k])).join('&')

        console.log(URLParams)

        const options = {
          method:"POST",
          headers:{
            'Content-Type':'application/x-www-form-urlencoded'
          },
          body:URLParams
        }

        $('#newUserForm').addClass('loading')
        fetch(`${baseURL}/register_user`, options)
        .then(res=>res.json())
        .then(res=>{
          $('#newUserForm').removeClass('loading')
          toast(res.message, res.status)
          if(res.status == 'success'){
            $("#resetButton").click()
            fetchAllUsers()
          }
        })
        .catch(err=>{
          $('#newUserForm').removeClass('loading')
          swal('Oops!', "Something went wrong with this request!", 'error')
        })
      }
    </script>

    <script>
      async function fetchAllUsers(){
        
        fetch(`${baseURL}/get_all_users`)
        .then(res=>res.json())
        .then(res=>{
          USERS = res.data
          if(res.status == 'success'){
            selectedUser = null
            if(res.status == 'success'){
              toast('Users list updated!', 'default')
              renderUsersTable()
            }else{
              toast(res.message, res.status)
            }
           
          }else{
            toast('Failed to update users list!', res.status)
          }
        })
        .catch(err=>{
          toast("Connection Error: Failed to process request!", 'error')
        })
      }

      function renderUsersTable(){
        try{users_table.destroy()}catch(e){console.error('Failed to destroy DataTable!')}
        let TableRows = USERS.map(row=>{
          return `<tr>
                        <td>${row.id}</td>
                        <td>${row.Firstname.toUpperCase()}</td>
                        <td>${row.Lastname.toUpperCase()}</td>
                        <td>${row.Middlename.toUpperCase()}</td>
                        <td>${row.EmailAddress}</td>
                        <td>${row.Role}</td>
                        <td>${row.Status}</td>
                        <td>
                          <input type="radio" name="selected_row" onchange="toggleRowSelection(${row.id})" class="row_select">
                        </td>
                      </tr>`
        })
        TableRows = TableRows.join('')
        $("#users_table tbody").html(TableRows)
        users_table = $("#users_table").DataTable({
                    searching:true,
                    buttons: [
                        'copy', 'excel', 'pdf'
                    ]
                });
      }

      function toggleRowSelection(uuid){
        selectedUser  = uuid
        console.log(selectedUser)
      }

      function resetPassword(){
        $("#list_segment").addClass('loading')
        fetch(`${baseURL}/reset_password`, {
          method:"POST",
          headers:{
            'Content-Type':'application/x-www-form-urlencoded'
          },
          body:`id=${selectedUser}`
        }).then(res=>res.json())
        .then(res=>{
          $("#list_segment").removeClass('loading')
          toast(res.message, res.status)
          if(res.status == 'success'){
              fetchAllUsers()
          }
        })
        .catch(err=>{
          $("#list_segment").removeClass('loading')
          swal('Oops!', "Something went wrong with this request!", 'error')
        })
      }

      function deleteUser(){
        let userData = getUserData()
        userData.Status = 'Deleted'
        const queryString = Object.keys(userData).map(key => key + '=' + userData[key]).join('&');
        $("#list_segment").addClass('loading')
        fetch(`${baseURL}/update_user`, {
          method:"POST",
          headers:{
            'Content-Type':'application/x-www-form-urlencoded'
          },
          body: queryString
        }).then(res=>res.json())
        .then(res=>{
          $("#list_segment").removeClass('loading')
          toast(res.message, res.status)
          if(res.status == 'success'){
              fetchAllUsers()
          }
        })
        .catch(err=>{
          $("#list_segment").removeClass('loading')
          swal('Oops!', "Something went wrong with this request!", 'error')
        })
      }

      function getUserData(){
        let userdata;
        for (let i = 0; i < USERS.length; i++) {
            if(USERS[i].id == selectedUser){
              userdata = USERS[selectedUser]
              break
            }
        }
        return userdata
      }
    </script>
</body>
</html>